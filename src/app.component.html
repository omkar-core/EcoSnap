<div class="h-screen w-screen bg-slate-950 flex flex-col overflow-hidden relative font-inter">
  
  <!-- GPS Error Toast -->
  @if (game.locationError()) {
    <div class="absolute top-0 left-0 right-0 z-[100] flex justify-center pt-4 pointer-events-none">
      <div class="bg-amber-900/95 backdrop-blur-md border border-amber-500/50 text-amber-50 px-4 py-3 rounded-lg shadow-2xl flex items-start gap-3 pointer-events-auto animate-slide-down max-w-sm w-[95%] sm:w-auto">
        <div class="text-xl mt-0.5">‚ö†Ô∏è</div>
        <div class="flex-1 text-sm">
          <p class="font-bold mb-1">Location Services Issue</p>
          <p class="opacity-90 leading-snug mb-3 text-xs sm:text-sm">{{ game.locationError() }}</p>
          <button (click)="game.retryLocation()" class="text-xs bg-amber-800 hover:bg-amber-700 text-amber-100 px-3 py-1.5 rounded border border-amber-600/50 transition-colors font-semibold shadow-sm active:scale-95">
             Retry GPS
          </button>
        </div>
        <button (click)="game.dismissLocationError()" class="text-amber-300 hover:text-white transition-colors p-1 -mt-1 -mr-2 rounded-full hover:bg-amber-800/50">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>
    </div>
  }

  <!-- System Notification Toast (Success/Error) -->
  @if (game.systemMessage(); as msg) {
    <div class="absolute top-16 left-0 right-0 z-[100] flex justify-center pt-4 pointer-events-none">
      <div class="backdrop-blur-md border px-4 py-3 rounded-lg shadow-2xl flex items-center gap-3 pointer-events-auto animate-slide-down max-w-sm w-[90%]"
           [class.bg-emerald-900_95]="msg.type === 'success'"
           [class.border-emerald-500_50]="msg.type === 'success'"
           [class.text-emerald-50]="msg.type === 'success'"
           [class.bg-red-900_95]="msg.type === 'error'"
           [class.border-red-500_50]="msg.type === 'error'"
           [class.text-red-50]="msg.type === 'error'"
           [class.bg-slate-800_95]="msg.type === 'info'"
           [class.border-slate-600_50]="msg.type === 'info'"
           [class.text-slate-100]="msg.type === 'info'">
        <div class="text-xl">
           @if (msg.type === 'success') { ‚úÖ }
           @else if (msg.type === 'error') { üõë }
           @else { ‚ÑπÔ∏è }
        </div>
        <div class="flex-1 text-sm font-medium">
          {{ msg.text }}
        </div>
        <button (click)="game.dismissToast()" class="opacity-70 hover:opacity-100 transition-opacity p-1">
           ‚úñ
        </button>
      </div>
    </div>
  }

  <!-- Main Content Area -->
  <main class="flex-1 overflow-hidden relative">
    @if (currentView() === 'landing') {
      <app-landing-view (finish)="navTo('dashboard')" class="h-full w-full block animate-fade-in"></app-landing-view>
    }
    @else if (currentView() === 'dashboard') {
      <app-dashboard-view 
         class="h-full w-full block animate-slide-in"
         (viewScan)="openHistoryItem($event)">
      </app-dashboard-view>
    }
    @else if (currentView() === 'community') {
      <app-community-view class="h-full w-full block animate-slide-in"></app-community-view>
    }
    @else if (currentView() === 'camera') {
      <app-camera-view (imageCaptured)="handleImageCapture($event)" (close)="navTo('dashboard')" class="h-full w-full block animate-fade-in"></app-camera-view>
    }
    @else if (currentView() === 'team') {
      <app-team-view class="h-full w-full block animate-slide-in"></app-team-view>
    }
  </main>

  <!-- AI Copilot Floating Action Button (Always Accessible) -->
  @if (!isProcessing() && currentView() !== 'landing') {
    <div class="fixed bottom-24 right-4 z-50 animate-pop-in">
       <button (click)="toggleAi()" 
               class="relative w-14 h-14 rounded-full bg-gradient-to-br from-violet-600 to-indigo-600 shadow-lg shadow-violet-900/50 flex items-center justify-center transition-transform hover:scale-105 active:scale-95 group border border-violet-400/30">
          <div class="absolute inset-0 rounded-full border border-violet-400 opacity-50 animate-ping group-hover:animate-none"></div>
          <div class="absolute inset-0 bg-violet-400 rounded-full blur-md opacity-30"></div>
          <span class="text-2xl relative z-10 filter drop-shadow">‚ú®</span>
       </button>
    </div>
  }

  <!-- AI Copilot Interface Overlay -->
  @if (isAiOpen()) {
    <div class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center sm:p-4 animate-fade-in" (click)="toggleAi()">
      <div (click)="$event.stopPropagation()" class="w-full h-[80vh] sm:h-[600px] sm:w-[400px] bg-slate-900/95 border border-violet-500/30 rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col overflow-hidden animate-slide-up relative">
         <div class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden">
            <div class="absolute -top-[100px] -right-[100px] w-[300px] h-[300px] bg-violet-900/20 rounded-full blur-[80px]"></div>
            <div class="absolute bottom-[100px] -left-[100px] w-[200px] h-[200px] bg-indigo-900/20 rounded-full blur-[60px]"></div>
         </div>
         <div class="flex items-center justify-between p-4 border-b border-violet-500/20 bg-slate-900/50 backdrop-blur">
            <div class="flex items-center gap-3">
               <div class="w-10 h-10 rounded-full bg-gradient-to-br from-violet-600 to-indigo-600 flex items-center justify-center shadow-lg">
                  <span class="text-lg">ü§ñ</span>
               </div>
               <div>
                  <h3 class="text-white font-bold text-sm">Gemini Copilot</h3>
                  <div class="flex items-center gap-1.5">
                     <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                     <span class="text-[10px] text-emerald-400 uppercase tracking-wider font-bold">Online</span>
                  </div>
               </div>
            </div>
            <button (click)="toggleAi()" class="p-2 hover:bg-white/5 rounded-full text-slate-400 transition-colors">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
         </div>
         <div class="flex-1 overflow-y-auto p-4 space-y-4">
            @for (msg of chatHistory(); track msg.timestamp) {
               <div class="flex gap-3 animate-pop-in" [class.flex-row-reverse]="msg.role === 'user'">
                  @if (msg.role === 'ai') {
                     <div class="w-8 h-8 rounded-full bg-violet-900/50 border border-violet-500/30 flex items-center justify-center shrink-0 text-xs">AI</div>
                  }
                  <div class="max-w-[80%] rounded-2xl p-3 text-sm leading-relaxed shadow-sm"
                       [class.bg-violet-600]="msg.role === 'user'"
                       [class.text-white]="msg.role === 'user'"
                       [class.bg-slate-800]="msg.role === 'ai'"
                       [class.text-slate-200]="msg.role === 'ai'"
                       [class.border]="msg.role === 'ai'"
                       [class.border-slate-700]="msg.role === 'ai'">
                     {{ msg.text }}
                     @if(msg.isTyping) {
                        <span class="inline-block w-1.5 h-4 bg-violet-400 ml-1 animate-pulse align-middle"></span>
                     }
                  </div>
               </div>
            }
            @if (isAiThinking()) {
               <div class="flex gap-3 animate-pop-in">
                  <div class="w-8 h-8 rounded-full bg-violet-900/50 border border-violet-500/30 flex items-center justify-center shrink-0 text-xs">AI</div>
                  <div class="bg-slate-800 border border-slate-700 rounded-2xl p-3 flex gap-1 items-center h-10">
                     <div class="w-1.5 h-1.5 bg-violet-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                     <div class="w-1.5 h-1.5 bg-violet-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                     <div class="w-1.5 h-1.5 bg-violet-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                  </div>
               </div>
            }
         </div>
         <div class="p-4 bg-slate-900/80 border-t border-violet-500/20 backdrop-blur">
            <div class="relative flex gap-2">
               <input #aiInput type="text" 
                      placeholder="Ask about waste, routes, or ecology..." 
                      class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-violet-500 transition-colors pr-12"
                      (keyup.enter)="sendToAi(aiInput.value); aiInput.value = ''">
               <button (click)="sendToAi(aiInput.value); aiInput.value = ''" 
                       class="absolute right-2 top-2 bottom-2 aspect-square bg-violet-600 hover:bg-violet-500 text-white rounded-lg flex items-center justify-center transition-colors shadow-lg">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
               </button>
            </div>
         </div>
      </div>
    </div>
  }

  <!-- Navigation Bar (Revolutionary Design) -->
  @if (!isProcessing() && !scanResult() && currentView() !== 'landing') {
    <nav class="fixed bottom-0 left-0 right-0 h-20 bg-slate-900/80 backdrop-blur-xl border-t border-slate-800 grid grid-cols-4 items-center z-40 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] animate-slide-up">
      <button (click)="navTo('dashboard')" 
              class="flex flex-col items-center justify-center gap-1 h-full w-full active:bg-white/5 transition-colors group relative">
        <div class="relative p-1">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 group-hover:-translate-y-1 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" [class.text-emerald-400]="currentView() === 'dashboard'" [class.text-slate-500]="currentView() !== 'dashboard'">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
           </svg>
           @if(currentView() === 'dashboard') {
             <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-8 h-1 bg-emerald-400 rounded-full blur-[2px]"></div>
           }
        </div>
        <span class="text-[10px] font-bold uppercase tracking-wider" [class.text-emerald-400]="currentView() === 'dashboard'" [class.text-slate-500]="currentView() !== 'dashboard'">Home</span>
      </button>
      <button (click)="navTo('community')"
              class="flex flex-col items-center justify-center gap-1 h-full w-full active:bg-white/5 transition-colors group relative">
        <div class="relative p-1">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 group-hover:-translate-y-1 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" [class.text-emerald-400]="currentView() === 'community'" [class.text-slate-500]="currentView() !== 'community'">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
           </svg>
           @if(currentView() === 'community') {
             <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-8 h-1 bg-emerald-400 rounded-full blur-[2px]"></div>
           }
        </div>
        <span class="text-[10px] font-bold uppercase tracking-wider" [class.text-emerald-400]="currentView() === 'community'" [class.text-slate-500]="currentView() !== 'community'">Health</span>
      </button>
      <div class="relative h-full w-full flex items-center justify-center -mt-8 pointer-events-none">
         <button (click)="navTo('camera')" 
                 class="relative pointer-events-auto w-16 h-16 rounded-2xl flex items-center justify-center text-white transform transition-all duration-300 group hover:scale-105 active:scale-95 shadow-[0_10px_30px_rgba(16,185,129,0.4)] btn-3d">
            <div class="absolute inset-0 bg-gradient-to-br from-emerald-400 via-teal-500 to-cyan-600 rounded-2xl animate-gradient-xy"></div>
            <div class="absolute inset-[2px] bg-black/10 backdrop-blur-[1px] rounded-[14px] border border-white/20"></div>
            <div class="relative z-10">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 drop-shadow-md group-hover:rotate-12 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
               </svg>
            </div>
         </button>
      </div>
      <button (click)="navTo('team')"
              class="flex flex-col items-center justify-center gap-1 h-full w-full active:bg-white/5 transition-colors group relative">
        <div class="relative p-1">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 group-hover:-translate-y-1 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" [class.text-emerald-400]="currentView() === 'team'" [class.text-slate-500]="currentView() !== 'team'">
             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
           </svg>
           @if(currentView() === 'team') {
             <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-8 h-1 bg-emerald-400 rounded-full blur-[2px]"></div>
           }
        </div>
        <span class="text-[10px] font-bold uppercase tracking-wider" [class.text-emerald-400]="currentView() === 'team'" [class.text-slate-500]="currentView() !== 'team'">Profile</span>
      </button>
    </nav>
  }

  <!-- Loading Overlay -->
  @if (isProcessing()) {
    <div class="fixed inset-0 z-50 bg-black/90 flex flex-col items-center justify-center backdrop-blur-sm animate-fade-in">
       <div class="relative w-32 h-32 mb-8">
         <div class="absolute inset-0 border-4 border-slate-800 rounded-full"></div>
         <div class="absolute inset-0 border-4 border-t-emerald-500 border-r-transparent border-b-transparent border-l-transparent rounded-full animate-spin"></div>
         <div class="absolute inset-4 bg-slate-900 rounded-full flex items-center justify-center animate-pulse">
            <span class="text-4xl">üëÅÔ∏è</span>
         </div>
       </div>
       <div class="text-emerald-400 font-black text-xl animate-pulse tracking-tight">ANALYZING ARTIFACT</div>
       <div class="text-slate-500 text-xs mt-2 max-w-xs text-center font-mono uppercase tracking-widest">Gemini 3 Vision Processing</div>
    </div>
  }

  <!-- Result Modal (Used for New Scans AND History View) -->
  @if (scanResult() && capturedImage()) {
    <app-scan-result 
      [result]="scanResult()!" 
      [imageSrc]="capturedImage()!"
      [isHistory]="isHistoryView()"
      [upcycleClaimed]="currentUpcycleClaimed()" 
      (onClaim)="claimPoints($event)"
      (claimUpcycle)="handleUpcycleClaim()"
      (close)="closeModal()">
    </app-scan-result>
  }

</div>